<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>School Map</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* This override makes the label fully transparent behind the text */
        .map-label {
            background-color: rgba(255,255,255,0.8);
        }
    </style>
</head>
<body>

<nav>
  <a href="{{ url_for('index') }}">Home</a> |
  <a href="{{ url_for('settings') }}">Settings</a> |
  <a href="{{ url_for('school_map') }}">Map</a> |
  <a href="{{ url_for('fantasy_map') }}">Fantasy Map</a>
</nav>

<h1>Live School Map of Network</h1>
<button id="edit-toggle">Enable Edit Mode</button>

<div id="map-container">
    <!-- The normal map background -->
    <img src="{{ url_for('static', filename='map.png') }}"
         alt="School Map"
         width="672" height="950">

    {% for idx, row in targets_df.iterrows() %}
        {% set short_name = row["Short Name"] %}
        {% set device_type = row["Device Type"] %}

        {# Only render if this device type is visible #}
        {% if device_type in visible_device_types %}
            {% set x = row["MapX"] %}
            {% set y = row["MapY"] %}
            {% set status_rec = latest_status[short_name] %}

            {% if status_rec["status"] == "OK" %}
                {% set color_class = "status-ok-text" %}
                {% set emoji = "‚úÖ" %}
            {% elif status_rec["status"] == "High Ping" %}
                {% set color_class = "status-high-text" %}
                {% set emoji = "üòü" %}
            {% else %}
                {% set color_class = "status-down-text" %}
                {% set emoji = "‚ùå" %}
            {% endif %}

            <div class="map-label {{ color_class }}"
                 data-shortname="{{ short_name }}"
                 style="left: {{ x }}px; top: {{ y }}px;">
                {{ short_name }} {{ emoji }}
            </div>
        {% endif %}
    {% endfor %}
</div>

<script>
const editToggleBtn = document.getElementById("edit-toggle");
let editMode = false;

/**
 * Toggle edit mode button
 */
editToggleBtn.addEventListener("click", function() {
    editMode = !editMode;
    this.textContent = editMode ? "Disable Edit Mode" : "Enable Edit Mode";
    
    const labels = document.querySelectorAll(".map-label");
    labels.forEach(label => {
        if (editMode) {
            label.classList.add("editable");
            label.addEventListener("mousedown", onMouseDown);
        } else {
            label.classList.remove("editable");
            label.removeEventListener("mousedown", onMouseDown);
        }
    });
});

let currentDrag = null;
let offsetX = 0;
let offsetY = 0;

/**
 * onMouseDown: start dragging a label
 */
function onMouseDown(e) {
    if (!editMode) return;
    currentDrag = e.target.closest(".map-label");
    if (!currentDrag) return;

    const rect = currentDrag.getBoundingClientRect();
    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;

    document.addEventListener("mousemove", onMouseMove);
    document.addEventListener("mouseup", onMouseUp);
}

/**
 * onMouseMove: move the label around
 */
function onMouseMove(e) {
    if (!editMode || !currentDrag) return;
    e.preventDefault();
    let containerRect = document.getElementById("map-container").getBoundingClientRect();

    let newLeft = e.clientX - containerRect.left - offsetX;
    let newTop = e.clientY - containerRect.top - offsetY;

    currentDrag.style.left = newLeft + "px";
    currentDrag.style.top = newTop + "px";
}

/**
 * onMouseUp: finalize the drag, save new position
 */
function onMouseUp(e) {
    if (!editMode || !currentDrag) return;
    let newLeft = parseInt(currentDrag.style.left, 10);
    let newTop = parseInt(currentDrag.style.top, 10);
    let shortName = currentDrag.getAttribute("data-shortname");

    // Save to server (normal map)
    let bodyData = { short_name: shortName, x: newLeft, y: newTop };
    fetch("{{ url_for('save_position') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(bodyData)
    })
    .then(res => res.json())
    .then(data => {
        if (!data.success) {
            alert("Could not save position: " + data.message);
        }
    })
    .catch(err => {
        alert("Error saving position");
        console.error(err);
    });

    document.removeEventListener("mousemove", onMouseMove);
    document.removeEventListener("mouseup", onMouseUp);
    currentDrag = null;
}
</script>

</body>
</html>
