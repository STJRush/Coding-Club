<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Fantasy Map</title>
    <!-- Link to your existing CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <!-- Load a fantasy font from Google Fonts (example: Uncial Antiqua) -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&display=swap" rel="stylesheet">
    
    <style>
        /* Override to keep label backgrounds transparent */
        .map-label {
            background-color: transparent !important;
            
            /* Apply our fantasy font and a bright off-white color */
            font-family: 'Uncial Antiqua', fantasy, cursive;
            color: #f5f2e8; /* a light off-white color */
            font-size: 1.1em; /* slightly larger text if desired */
        }
    </style>
</head>
<body>

<nav>
  <a href="{{ url_for('index') }}">Home</a> |
  <a href="{{ url_for('settings') }}">Settings</a> |
  <a href="{{ url_for('school_map') }}">Map</a> |
  <a href="{{ url_for('fantasy_map') }}">Fantasy Map</a>
</nav>

<h1>Fantasy Map</h1>
<button id="edit-toggle">Enable Edit Mode</button>

<div id="map-container">
    <!-- Large fantasy background (example 1200x900) -->
    <img src="{{ url_for('static', filename='fantasybackground.png') }}"
         alt="Fantasy Background"
         width="1200" height="900">

    {% for idx, row in targets_df.iterrows() %}
        {% set short_name = row["Short Name"] %}
        {% set device_type = row["Device Type"] %}

        {# Only render if device_type is visible #}
        {% if device_type in visible_device_types %}
            {% set fant_name = row["FantName"] %}
            {% if not fant_name %}
                {% set fant_name = short_name %}
            {% endif %}

            {% set x = row["FantX"] %}
            {% set y = row["FantY"] %}
            {% set status_rec = latest_status[short_name] %}
            {% set status = status_rec["status"] %}

            {# Determine device image #}
            {% if status == "OK" %}
                {% set image_file = "healthy.gif" %}
            {% elif status == "High Ping" %}
                {% set image_file = "slow.gif" %}
            {% else %}
                {% set image_file = "unreachable.gif" %}
            {% endif %}

            {% set folder = device_type if device_type else "Other" %}
            {% set image_path = folder ~ "/" ~ image_file %}

            <div class="map-label"
                 data-shortname="{{ short_name }}"
                 style="left: {{ x }}px; top: {{ y }}px;">
                <img src="{{ url_for('static', filename=image_path) }}"
                     alt="{{ short_name }}"
                     width="60" height="60">
                <br>
                {{ fant_name }}
            </div>
        {% endif %}
    {% endfor %}
</div>

<script>
const editToggleBtn = document.getElementById("edit-toggle");
let editMode = false;

/**
 * Toggle edit mode
 */
editToggleBtn.addEventListener("click", function() {
    editMode = !editMode;
    this.textContent = editMode ? "Disable Edit Mode" : "Enable Edit Mode";
    
    const labels = document.querySelectorAll(".map-label");
    labels.forEach(label => {
        if (editMode) {
            label.classList.add("editable");
            label.addEventListener("mousedown", onMouseDown);
        } else {
            label.classList.remove("editable");
            label.removeEventListener("mousedown", onMouseDown);
        }
    });
});

let currentDrag = null;
let offsetX = 0;
let offsetY = 0;

/**
 * onMouseDown: start dragging
 */
function onMouseDown(e) {
    if (!editMode) return;
    currentDrag = e.target.closest(".map-label");
    if (!currentDrag) return;

    const rect = currentDrag.getBoundingClientRect();
    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;

    document.addEventListener("mousemove", onMouseMove);
    document.addEventListener("mouseup", onMouseUp);
}

/**
 * onMouseMove: drag label
 */
function onMouseMove(e) {
    if (!editMode || !currentDrag) return;
    e.preventDefault();

    let containerRect = document.getElementById("map-container").getBoundingClientRect();
    let newLeft = e.clientX - containerRect.left - offsetX;
    let newTop = e.clientY - containerRect.top - offsetY;

    currentDrag.style.left = newLeft + "px";
    currentDrag.style.top = newTop + "px";
}

/**
 * onMouseUp: finalize drag, save fantasy position
 */
function onMouseUp(e) {
    if (!editMode || !currentDrag) return;

    let newLeft = parseInt(currentDrag.style.left, 10);
    let newTop = parseInt(currentDrag.style.top, 10);
    let shortName = currentDrag.getAttribute("data-shortname");

    // Save to server (/fantasymap/save_position)
    let bodyData = { short_name: shortName, x: newLeft, y: newTop };
    fetch("{{ url_for('save_fantasy_position') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(bodyData)
    })
    .then(res => res.json())
    .then(data => {
        if (!data.success) {
            alert("Could not save position: " + data.message);
        }
    })
    .catch(err => {
        alert("Error saving position");
        console.error(err);
    });

    document.removeEventListener("mousemove", onMouseMove);
    document.removeEventListener("mouseup", onMouseUp);
    currentDrag = null;
}
</script>

</body>
</html>
